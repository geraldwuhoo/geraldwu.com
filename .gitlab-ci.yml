stages:
  - prepare
  - build
  - deploy

variables:
  RESUME_IMAGE: "build-resume"
  OUTPUT_DIR: "out"

meta-build-resume-image:
  image: docker:stable
  services:
    - docker:stable-dind
  stage: prepare
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login --username "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE/$RESUME_IMAGE:latest" -t "$CI_REGISTRY_IMAGE/$RESUME_IMAGE:$CI_COMMIT_SHORT_SHA" -f meta/Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE/$RESUME_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE/$RESUME_IMAGE:$CI_COMMIT_SHORT_SHA"
  only:
    changes:
      - meta/Dockerfile

build:
  image: "$CI_REGISTRY_IMAGE/$RESUME_IMAGE"
  stage: build
  script:
    - python3 main.py
    - pandoc --self-contained --css resume/style.css --output "$OUTPUT_DIR/resume.html" "$OUTPUT_DIR/resume.md"
    - wkhtmltopdf --page-size letter "$OUTPUT_DIR/resume.html" "$OUTPUT_DIR/resume.pdf"
    - cp -av "$OUTPUT_DIR"/* website/style.css .
  artifacts:
    paths:
      - index.html
      - style.css
      - resume.pdf

deploy:
  image: alpine:3
  stage: deploy
  before_script:
    - 'which ssh-agent || (apk update && apk add openssh-client)'
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - export DEPLOY_BRANCH="$([ "$CI_COMMIT_BRANCH" = "master" ] || echo "$CI_COMMIT_BRANCH")"
  script:
    - scp index.html,style.css,resume.pdf "${SITE_PATH}/${DEPLOY_BRANCH}"
